generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Hackathon {
  id              String         @id @default(uuid())
  title           String
  description     String
  location        String
  total_prizes    Int
  tags            String[]
  content         Json           @default("{}")
  end_date        DateTime       @default(now()) @db.Timestamptz(3)
  start_date      DateTime       @default(now()) @db.Timestamptz(3)
  timezone        String         @default("UTC")
  banner          String         @default("")
  icon            String         @default("")
  small_banner    String         @default("")
  participants    Int
  top_most        Boolean?       @default(false)
  organizers      String?
  custom_link     String?
  created_by      String?
  is_public       Boolean?
  updated_by      String?
  event           String?        @default("hackathon")
  created_by_user User?          @relation(fields: [created_by], references: [id])
  updated_by_user User?          @relation("HackathonUpdatedBy", fields: [updated_by], references: [id])
  projects        Project[]
  registrations   RegisterForm[]
  cohosts         String[]       @default([])
}

model User {
  id                       String                    @id @default(cuid())
  name                     String?
  email                    String?                   @unique
  image                    String?
  authentication_mode      String?
  integration              String?
  last_login               DateTime?
  user_name                String?
  bio                      String?
  notification_email       String?
  profile_privacy          String?                   @default("public")
  social_media             String[]
  notifications            Boolean?
  custom_attributes        String[]
  telegram_user            String?
  created_at               DateTime                  @default(now()) @db.Timestamptz(3)
  country                  String?
  user_type                Json?
  github                   String?
  skills                   String[]                  @default([])
  noun_avatar_seed         Json?
  noun_avatar_enabled      Boolean                   @default(false)
  wallet                   String[]                  @default([])
  consoleLog               ConsoleLog[]
  faucetClaims             FaucetClaim[]
  hackathons               Hackathon[]
  updated_hackathons       Hackathon[]               @relation("HackathonUpdatedBy")
  memberships              Member[]
  managedTestnetNodes      NodeRegistration[]
  registrations            RegisterForm[]
  statsPlaygrounds         StatsPlayground[]
  statsPlaygroundFavorites StatsPlaygroundFavorite[] @relation("StatsPlaygroundFavorites")
  chatConversations   ChatConversation[]
  badges                   UserBadge[]
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model RegisterForm {
  id                      String    @id @default(uuid())
  utm                     String
  city                    String
  dietary                 String?
  email                   String
  interests               String
  languages               String
  roles                   String
  name                    String
  role                    String
  tools                   String
  company_name            String?
  created_at              DateTime  @default(now()) @db.Timestamptz(3)
  github_portfolio        String?
  hackathon_id            String
  hackathon_participation String
  newsletter_subscription Boolean   @default(false)
  prohibited_items        Boolean   @default(false)
  terms_event_conditions  Boolean   @default(false)
  updated_at              DateTime  @updatedAt @db.Timestamptz(3)
  web3_proficiency        String
  telegram_user           String?
  referrer_handle         String?
  user                    User      @relation(fields: [email], references: [email], onDelete: Cascade)
  hackathon               Hackathon @relation(fields: [hackathon_id], references: [id], onDelete: Cascade)

  @@unique([hackathon_id, email])
}

model Project {
  id                  String         @id @default(uuid())
  hackaton_id         String?
  project_name        String
  short_description   String
  full_description    String?        @default("")
  tech_stack          String?        @default("")
  github_repository   String?        @default("")
  demo_link           String?        @default("")
  logo_url            String?        @default("")
  cover_url           String?        @default("")
  demo_video_link     String?        @default("")
  screenshots         String[]       @default([])
  tracks              String[]       @default([])
  created_at          DateTime       @default(now()) @db.Timestamptz(3)
  updated_at          DateTime       @updatedAt @db.Timestamptz(3)
  explanation         String?        @default("")
  is_preexisting_idea Boolean        @default(false)
  small_cover_url     String?        @default("")
  tags                String[]       @default([])
  is_winner           Boolean?       @default(false)
  origin              String         @default("unknown")
  categories          String[]       @default([])
  other_category      String?
  formData            FormData[]
  members             Member[]
  prizes              Prize[]
  hackathon           Hackathon?     @relation(fields: [hackaton_id], references: [id], onDelete: Cascade)
  badges              ProjectBadge[]
}

model Prize {
  id         String  @id @default(uuid())
  icon       String
  prize      Int
  track      String
  project_id String
  Project    Project @relation(fields: [project_id], references: [id], onDelete: Cascade)
}

model Member {
  id         String  @id @default(uuid())
  user_id    String?
  project_id String
  role       String  @default("member")
  status     String  @default("Pending Confirmation")
  email      String?
  project    Project @relation(fields: [project_id], references: [id], onDelete: Cascade)
  user       User?   @relation(fields: [user_id], references: [id], onDelete: Cascade)
}

model Badge {
  id              String         @id @default(uuid())
  name            String
  description     String
  image_path      String
  category        String
  requirements    Json[]         @default([])
  current_version Int            @default(1)
  projects        ProjectBadge[]
  users           UserBadge[]
}

model UserBadge {
  id                   String   @id @default(uuid())
  user_id              String
  badge_id             String
  awarded_at           DateTime @default(now())
  awarded_by           String?
  evidence             Json?
  requirements_version Int      @default(1)
  status               Int      @db.SmallInt
  badge                Badge    @relation(fields: [badge_id], references: [id], onDelete: Cascade)
  user                 User     @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@unique([user_id, badge_id])
}

model ProjectBadge {
  id                    String   @id @default(uuid())
  project_id            String
  badge_id              String
  awarded_at            DateTime @default(now())
  awarded_by            String?
  evidence              Json?
  requirements_snapshot Json     @default("{}")
  requirements_version  Int      @default(1)
  status                Int      @db.SmallInt
  badge                 Badge    @relation(fields: [badge_id], references: [id], onDelete: Cascade)
  project               Project  @relation(fields: [project_id], references: [id], onDelete: Cascade)

  @@unique([project_id, badge_id])
}

model NodeRegistration {
  id                  String   @id @default(uuid())
  user_id             String
  subnet_id           String
  blockchain_id       String
  node_id             String
  node_index          Int?
  public_key          String
  proof_of_possession String
  rpc_url             String
  chain_name          String?
  status              String   @default("active")
  created_at          DateTime @default(now()) @db.Timestamptz(3)
  expires_at          DateTime @db.Timestamptz(3)
  updated_at          DateTime @updatedAt @db.Timestamptz(3)
  user                User     @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@unique([user_id, subnet_id, node_index])
  @@index([user_id])
  @@index([status])
  @@index([subnet_id])
}

model ConsoleLog {
  id          String   @id @default(uuid())
  user_id     String
  status      String
  action_path String?
  data        Json?
  created_at  DateTime @default(now()) @db.Timestamptz(3)
  user        User     @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([user_id])
  @@index([created_at])
}

model StatsPlayground {
  id         String                    @id @default(uuid())
  user_id    String
  name       String
  is_public  Boolean                   @default(false)
  charts     Json
  created_at DateTime                  @default(now()) @db.Timestamptz(3)
  updated_at DateTime                  @updatedAt @db.Timestamptz(3)
  view_count Int                       @default(0)
  user       User                      @relation(fields: [user_id], references: [id], onDelete: Cascade)
  favorites  StatsPlaygroundFavorite[]

  @@index([user_id])
  @@index([is_public])
  @@index([created_at])
}

model StatsPlaygroundFavorite {
  id            String          @id @default(uuid())
  playground_id String
  user_id       String
  created_at    DateTime        @default(now()) @db.Timestamptz(3)
  playground    StatsPlayground @relation(fields: [playground_id], references: [id], onDelete: Cascade)
  user          User            @relation("StatsPlaygroundFavorites", fields: [user_id], references: [id], onDelete: Cascade)

  @@unique([playground_id, user_id])
  @@index([playground_id])
  @@index([user_id])
}

model FaucetClaim {
  id                  String   @id @default(uuid())
  user_id             String
  faucet_type         String
  chain_id            String?
  destination_address String
  amount              String
  tx_hash             String?
  created_at          DateTime @default(now()) @db.Timestamptz(3)
  user                User     @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([user_id])
  @@index([destination_address])
  @@index([created_at])
  @@index([faucet_type, chain_id])
}

model ChatConversation {
  id         String        @id @default(uuid())
  user_id    String
  title      String
  created_at DateTime      @default(now()) @db.Timestamptz(3)
  updated_at DateTime      @updatedAt @db.Timestamptz(3)

  // Sharing fields
  is_shared        Boolean   @default(false)
  share_token      String?   @unique  // Cryptographically secure, non-guessable
  shared_at        DateTime? @db.Timestamptz(3)
  share_expires_at DateTime? @db.Timestamptz(3)  // Link expiration (default: 30 days from share)
  view_count       Int       @default(0)

  user       User          @relation(fields: [user_id], references: [id], onDelete: Cascade)
  messages   ChatMessage[]

  @@index([user_id])
  @@index([updated_at])
  @@index([share_token])  // Fast public lookup
  @@index([is_shared])    // Filter shared conversations
}

model ChatMessage {
  id              String           @id @default(uuid())
  conversation_id String
  role            String           // "user" or "assistant"
  content         String           @db.Text
  created_at      DateTime         @default(now()) @db.Timestamptz(3)
  conversation    ChatConversation @relation(fields: [conversation_id], references: [id], onDelete: Cascade)

  @@index([conversation_id])
  @@index([created_at])
}

model FormData {
  id         String   @id @default(dbgenerated("gen_random_uuid()"))
  form_data  Json
  timestamp  DateTime @db.Timestamptz(6)
  origin     String   @default("unknown")
  project_id String
  project    Project  @relation(fields: [project_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
}

model BuildGamesApplication {
  id                         String   @id @default(uuid())
  email                      String   @unique
  first_name                 String
  last_name                  String
  telegram                   String?
  github                     String?
  country                    String
  ready_to_win               String
  previous_avalanche_grant   String
  hackathon_experience       String?
  hackathon_details          String?
  employment_role            String?
  current_role               String?
  employment_status          String?
  project_name               String
  project_description        String
  area_of_focus              String
  why_you                    String
  how_did_you_hear           String
  how_did_you_hear_specify   String?
  referrer_name              String?
  referrer_handle            String?
  university_affiliation     String
  avalanche_ecosystem_member String
  privacy_policy_read        Boolean  @default(false)
  marketing_consent          Boolean  @default(false)
  created_at                 DateTime @default(now()) @db.Timestamptz(3)
  updated_at                 DateTime @updatedAt @db.Timestamptz(3)

  @@index([created_at])
  @@index([referrer_handle])
  @@index([area_of_focus])
}

model Retro9000ReturningApplication {
  id                              String   @id @default(uuid())
  email                           String   @unique

  // PROJECT OVERVIEW
  project_name                    String
  project_type                    String
  project_vertical                String
  project_website                 String?
  project_x_handle                String?
  project_github                  String
  project_hq                      String
  project_continent               String
  media_kit                       String

  // FINANCIAL OVERVIEW
  previous_retro9000_snapshot_funding String?
  requested_funding_range         String

  // GRANT INFORMATION
  eligibility_and_metrics         String   @db.Text
  requested_grant_size_budget     String
  changes_since_last_snapshot     String   @db.Text

  // APPLICANT INFORMATION
  first_name                      String
  last_name                       String
  pseudonym                       String?
  role                            String
  x_account                       String
  telegram                        String
  linkedin                        String?
  github                          String?
  country                         String?
  other_url                       String?
  bio                             String   @db.Text

  // COMPLIANCE
  kyb_willing                     String
  gdpr                            Boolean  @default(false)
  marketing_consent               Boolean  @default(false)

  created_at                      DateTime @default(now()) @db.Timestamptz(3)
  updated_at                      DateTime @updatedAt @db.Timestamptz(3)

  @@index([created_at])
  @@index([project_name])
  @@index([project_vertical])
  @@index([requested_funding_range])
}
